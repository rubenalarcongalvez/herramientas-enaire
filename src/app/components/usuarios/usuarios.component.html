<p-toast/>

<p-table
    #dt
    [value]="usuariosTabla()"
    rowHover
    dataKey="id"
    [globalFilterFields]="['nombre', 'alias', 'cumpleanos']"
    responsiveLayout="stack"
    breakpoint="750px"
    [multiSortMeta]="sortMeta"
    (onStateRestore)="onStateRestored($event)"
    sortMode="multiple"
    stateStorage="local"
    stateKey="orden-tabla-usuarios"
>
    <ng-template #caption>
        <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
                <h4 class="m-0 text-center">Usuarios</h4>
                <i class="pi pi-info-circle text-blue-500" pTooltip="La elección del orden de la tabla se guardará para siguientes usos"></i>
            </div>
            <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon>
                    <i class="pi pi-search"></i>
                </p-inputicon>
                <input pInputText pSize="small" type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="Buscar..." />
            </p-iconfield>
            <div class="flex gap-3 items-center">
                <p-button (onClick)="usuarioDialog = true" class="flex gap-2 items-center">
                    <span>Añadir usuario</span>
                    <i class="pi pi-plus"></i>
                </p-button>
            </div>
        </div>
    </ng-template>
    <ng-template #header>
        <tr>
            <th pSortableColumn="alias">
                Alias
                <p-sortIcon field="alias" />
            </th>
            <th pSortableColumn="nombre">
                Nombre
                <p-sortIcon field="nombre" />
            </th>
            <th pSortableColumn="cumpleanos">
                Cumpleaños
                <p-sortIcon field="cumpleanos"/>
            </th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template #body let-usuario>
        <tr>
            <td>
                <span class="flex items-center gap-2 my-2 w-full">{{ usuario?.alias }}</span>
            </td>
            <td>
                <span class="flex items-center gap-2 my-2 w-full">{{ usuario?.nombre }}</span>
            </td>
            <td>
                <span class="flex w-full">{{ usuario.cumpleanos }}</span>
            </td>
            <td>
                <i class="pi pi-pencil mr-3 text-orange-500 cursor-pointer" (click)="ponerDatosEditarUsuario(usuario.id); usuarioDialog = true" pTooltip="Editar"></i>
                <i class="pi pi-trash text-red-500 cursor-pointer" (click)="eliminarUsuario(usuario)" pTooltip="Eliminar"></i>
            </td>
        </tr>
    </ng-template>
</p-table>

<p-confirmDialog draggable="false"/>

<!-- Dialogos -->
<!-- Anadir Usuario -->
<p-dialog 
    [(visible)]="usuarioDialog" 
    [modal]="true" 
    [dismissableMask]="false"
    draggable="false"
    maximizable
    styleClass="p-3 w-[500px]"
    (onShow)="ponerFocusInputPrincipal()"
    (onHide)="formUsuario?.reset()"
>
    <ng-template pTemplate="header">
        <h2>{{ formUsuario?.get('id')?.value ? 'Editar' : 'Añadir' }} usuario</h2>
    </ng-template>
    
    <form [formGroup]="formUsuario!" (ngSubmit)="aplicarUsuario()" (keydown.enter)="aplicarUsuario()" class="flex flex-col items-center gap-3 w-full">
        <input placeholder="Nombre y apellidos" pInputText id="nombre" #nombre class="flex-auto w-full text-lg inputPrincipal" autocomplete="off" formControlName="nombre"/>
        <input placeholder="Alias" pInputText id="alias" #alias class="flex-auto w-full text-lg" autocomplete="off" formControlName="alias"/>
        <p-datepicker placeholder="Cumpleaños" [firstDayOfWeek]="1" appendTo="body" formControlName="cumpleanos" [iconDisplay]="'input'" [showIcon]="true" class="w-full" styleClass="w-full" inputId="icondisplay" dateFormat="dd/mm"/>
        @if (formUsuario?.get('nombre')?.dirty && formUsuario?.get('nombre')?.invalid) {
            <p-message severity="error" class="w-full">El nombre completo es obligatorio</p-message>
        }
    </form>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2 p-2">
            <p-button 
                label="Cancelar" 
                [text]="true" 
                styleClass="cancel"
                (onClick)="usuarioDialog = false" 
            />
            <p-button 
                label="Añadir" 
                (onClick)="aplicarUsuario()" 
            />
        </div>
    </ng-template>
</p-dialog>
